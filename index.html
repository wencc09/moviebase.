<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MovieBaseï½œæ¼‚æµ®å½±å»³ Ã— è§€å½±æ—¥è¨˜</title>

  <!-- Google Sign-In (GIS) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    /* =====================
       MovieBase Dark UI
    ===================== */
    :root{
      --bg0:#070A12;
      --bg1:#0B1222;
      --card:rgba(255,255,255,.07);
      --card2:rgba(255,255,255,.10);
      --stroke:rgba(255,255,255,.10);
      --text:#EAF0FF;
      --muted:rgba(234,240,255,.68);
      --brandA:#7C3AED;
      --brandB:#06B6D4;
      --good:#34D399;
      --bad:#FB7185;
      --warn:#FBBF24;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      color:var(--text);
      background:
        radial-gradient(900px 450px at 15% 0%, rgba(124,58,237,.35), transparent 55%),
        radial-gradient(900px 450px at 80% 10%, rgba(6,182,212,.28), transparent 55%),
        radial-gradient(1100px 600px at 50% 110%, rgba(20,184,166,.14), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      min-height:100vh;
      overflow-x:hidden;
    }

    /* Floating grain */
    body::before{
      content:"";
      position:fixed; inset:0;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='180' height='180'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='180' height='180' filter='url(%23n)' opacity='.12'/%3E%3C/svg%3E");
      opacity:.35;
      pointer-events:none;
      mix-blend-mode: overlay;
    }

    a{ color:inherit; }

    header{
      position:sticky;
      top:0;
      z-index:30;
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      background: rgba(10,14,24,.65);
      border-bottom:1px solid var(--stroke);
    }

    .wrap{
      max-width: 1100px;
      margin:0 auto;
      padding: 14px 16px;
    }

    .topbar{
      display:flex;
      align-items:center;
      gap:12px;
      justify-content:space-between;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 220px;
    }

    .logo{
      width:38px; height:38px; border-radius: 14px;
      background: linear-gradient(135deg, rgba(124,58,237,1), rgba(6,182,212,1));
      box-shadow: 0 12px 32px rgba(124,58,237,.25), 0 10px 28px rgba(6,182,212,.18);
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-40%;
      background: conic-gradient(from 30deg, transparent 0 25%, rgba(255,255,255,.35) 35%, transparent 55% 100%);
      animation: shine 5.2s linear infinite;
    }
    @keyframes shine{
      0%{ transform: rotate(0deg); }
      100%{ transform: rotate(360deg); }
    }

    .brand h1{
      margin:0;
      font-size: 15px;
      letter-spacing:.4px;
      line-height:1.2;
    }
    .brand .sub{
      font-size:12px;
      color:var(--muted);
    }

    .right{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    .pill{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      color: var(--muted);
    }

    .tabs{
      margin-top:12px;
      display:flex;
      gap:10px;
      overflow:auto;
      padding-bottom: 8px;
      -webkit-overflow-scrolling: touch;
    }
    .tab{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 14px;
      border-radius: 999px;
      font-size: 13px;
      cursor:pointer;
      transition:.2s;
      white-space:nowrap;
    }
    .tab:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.18);
      background: rgba(255,255,255,.09);
    }
    .tab.is-active{
      background: linear-gradient(135deg, rgba(124,58,237,.90), rgba(6,182,212,.75));
      border-color: transparent;
      box-shadow: 0 10px 26px rgba(124,58,237,.20);
    }

    main{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px 16px 70px;
      display:grid;
      gap:14px;
    }

    @media (min-width: 980px){
      main{ grid-template-columns: 380px 1fr; align-items:start; }
    }

    .card{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .cardHead{
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.07);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .cardHead h2{
      margin:0;
      font-size:14px;
      letter-spacing:.4px;
    }
    .cardHead .muted{ color:var(--muted); font-size:12px; }

    .cardBody{ padding: 14px; }

    label{ display:block; margin-top:10px; font-size:12px; color: var(--muted); }
    input, select, textarea{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(6,8,14,.50);
      color: var(--text);
      outline:none;
    }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(6,182,212,.45);
      box-shadow: 0 0 0 4px rgba(6,182,212,.12);
    }
    textarea{ min-height: 90px; resize: vertical; }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .row{ grid-template-columns: 1fr; }
    }

    .btns{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    button{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition:.18s;
      font-size:13px;
    }
    button:hover{ transform: translateY(-1px); background: rgba(255,255,255,.10); }
    button:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    .primary{
      border:none;
      background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(6,182,212,.75));
      box-shadow: 0 12px 28px rgba(124,58,237,.20);
    }
    .danger{
      border:none;
      background: linear-gradient(135deg, rgba(251,113,133,.85), rgba(124,58,237,.50));
    }

    .thumb{
      width:58px;
      height:58px;
      border-radius: 14px;
      object-fit:cover;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
    }

    .status{
      margin-top:10px;
      font-size:12px;
      color: var(--muted);
      white-space: pre-wrap;
      line-height:1.45;
    }
    .ok{ color: var(--good); }
    .err{ color: var(--bad); }
    .warn{ color: var(--warn); }

    /* Feed styles (Floating Cinema) */
    .cinemaTitle{
      padding: 14px;
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .cinemaDot{
      width:10px; height:10px; border-radius:999px;
      background: rgba(255,255,255,.18);
      margin-top:4px;
      box-shadow: 0 0 0 6px rgba(255,255,255,.06);
    }
    .cinemaTitle .big{
      font-weight:800;
      letter-spacing:.5px;
    }
    .cinemaTitle .small{
      margin-top:4px;
      font-size:12px;
      color: var(--muted);
      line-height:1.4;
    }

    .searchRow{
      padding: 0 14px 14px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .searchRow input{
      flex:1;
      min-width: 220px;
    }
    .countPill{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      padding: 10px 12px;
      border-radius: 999px;
      color: var(--muted);
      font-size: 12px;
    }

    .feed{
      padding: 14px;
      display:grid;
      gap:12px;
    }

    .post{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      border-radius: 18px;
      overflow:hidden;
      transition: .2s;
      position:relative;
    }
    .post:hover{
      transform: translateY(-2px);
      border-color: rgba(255,255,255,.18);
    }

    .postHead{
      padding: 12px 12px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .user{
      display:flex;
      gap:10px;
      align-items:center;
      min-width: 0;
    }
    .avatar{
      width:36px; height:36px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.07);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
    }
    .uMeta{ min-width:0; }
    .uTitle{
      font-weight:900;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .uSub{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .ts{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }

    .postImg{
      width:100%;
      max-height: 520px;
      object-fit: cover;
      display:block;
      background: rgba(255,255,255,.06);
    }

    .postActions{
      padding: 10px 12px 0;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .chipBtn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 12px;
      cursor:pointer;
    }
    .chipBtn:hover{
      background: rgba(255,255,255,.10);
    }

    .postBody{
      padding: 12px;
      display:grid;
      gap:8px;
    }
    .badges{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .badge{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: var(--muted);
    }
    .text{
      white-space: pre-wrap;
      line-height: 1.55;
      font-size: 13px;
      color: rgba(234,240,255,.92);
    }

    .hint{
      padding: 12px 14px;
      color: var(--muted);
      font-size:12px;
      line-height:1.5;
      border-top: 1px solid rgba(255,255,255,.08);
    }

    .userBox{
      display:none;
      align-items:center;
      gap:10px;
    }
    .userPic{
      width:28px; height:28px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      display:none;
    }
    .userName{
      font-size:12px;
      color: var(--muted);
    }

    /* subtle floating animation on cards */
    .floaty{
      animation: floaty 7s ease-in-out infinite;
    }
    @keyframes floaty{
      0%,100%{ transform: translateY(0px); }
      50%{ transform: translateY(-6px); }
    }

    /* mobile panels */
    @media (max-width: 979px){
      main{ grid-template-columns:1fr; }
      #panelCreate{ display:none; }
    }
  </style>
</head>

<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>MovieBase</h1>
            <div class="sub">æ¼‚æµ®å½±å»³ Ã— è§€å½±æ—¥è¨˜ï¼ˆGitHub Pages å‰ç«¯ + Apps Script å¾Œç«¯ï¼‰</div>
          </div>
        </div>

        <div class="right">
          <div class="pill" id="modeBadge">ç›®å‰ï¼šæœªç™»å…¥</div>

          <!-- æœªç™»å…¥ï¼šè¨ªå®¢ + Google -->
          <div id="loginButtons" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <button id="btnGuest" type="button">ä»¥è¨ªå®¢é€²å…¥</button>
            <div id="gsiBtn"></div>
          </div>

          <!-- å·²ç™»å…¥ -->
          <div id="userBox" class="userBox">
            <img id="userPic" class="userPic" alt="">
            <div class="userName" id="userName"></div>
            <button id="btnLogout" type="button">ç™»å‡º</button>
          </div>
        </div>
      </div>

      <div class="tabs" id="tabs">
        <button class="tab is-active" data-tab="feed" type="button">ğŸ¥ æ¼‚æµ®å½±å»³</button>
        <button class="tab" data-tab="create" type="button">âœï¸ æ–°å¢è²¼æ–‡</button>
        <button class="tab" data-tab="about" type="button">âœ¨ é—œæ–¼</button>
      </div>
    </div>
  </header>

  <main>
    <!-- Create -->
    <section class="card floaty" id="panelCreate">
      <div class="cardHead">
        <div>
          <h2>âœï¸ æ–°å¢è²¼æ–‡ï¼ˆpostsï¼‰</h2>
          <div class="muted">å¯«å…¥ Spreadsheet â†’ posts</div>
        </div>
        <div class="muted" id="createHint">ç™»å…¥å¾Œå¯å¸¶å…¥ä½œè€…è³‡è¨Š</div>
      </div>

      <div class="cardBody">
        <label>ç‰‡åï¼ˆå¿…å¡«ï¼‰</label>
        <input id="title" placeholder="ä¾‹å¦‚ï¼šé€²æ“Šçš„å·¨äºº æœ€çµ‚å­£" />

        <div class="row">
          <div>
            <label>é¡åˆ¥</label>
            <select id="category">
              <option value="é›»å½±">é›»å½±</option>
              <option value="å½±é›†">å½±é›†</option>
              <option value="å‹•ç•«">å‹•ç•«</option>
              <option value="å‹•ç•«é›»å½±">å‹•ç•«é›»å½±</option>
            </select>
          </div>
          <div>
            <label>å¹³å°</label>
            <select id="platform">
              <option value="Netflix">Netflix</option>
              <option value="Disney+">Disney+</option>
              <option value="YouTube">YouTube</option>
              <option value="bilibili">bilibili</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>è©•åˆ†ï¼ˆ1~10ï¼‰</label>
            <input id="rating" type="number" min="1" max="10" value="8" />
          </div>
          <div>
            <label>è§€çœ‹æ—¥æœŸ</label>
            <input id="watchDate" type="date" />
          </div>
        </div>

        <label>å¿ƒå¾—</label>
        <textarea id="review" placeholder="å¯«ä¸‹ä½ çš„æ„Ÿæƒ³â€¦ï¼ˆå¯æ”¾ #hashtagï¼‰"></textarea>

        <label>å‚™è¨»</label>
        <input id="note" placeholder="ä¾‹å¦‚ï¼šæ¨è–¦çµ¦æœ‹å‹ / æƒ³äºŒåˆ·" />

        <label>#Hashtagsï¼ˆå¯é¸ï¼‰</label>
        <input id="hashtags" placeholder="ä¾‹å¦‚ï¼š#é€²æ“Šçš„å·¨äºº #åœ°é³´ #æœ€å¾Œä¸€å­£" />

        <label>ä¸Šå‚³ç…§ç‰‡ï¼ˆæµ·å ±/æˆªåœ–ï¼Œå¯é¸ï¼‰</label>
        <input id="photo" type="file" accept="image/*" />
        <div style="display:flex;gap:10px;align-items:center;margin-top:10px;">
          <img id="photoPreview" class="thumb" alt="">
          <div class="muted" style="font-size:12px;line-height:1.4;">
            å»ºè­°å°æ–¼ 500KBï¼ˆä¸Šå‚³æ›´ç©©ï¼‰ã€‚<br>ç…§ç‰‡æœƒå­˜åˆ° Driveï¼ŒSheet å­˜ photoUrlã€‚
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnCreate" type="button">æ–°å¢è²¼æ–‡</button>
          <button id="btnReload" type="button">é‡æ–°æ•´ç†è²¼æ–‡ç‰†</button>
        </div>

        <div id="status" class="status"></div>
      </div>
    </section>

    <!-- Feed -->
    <section class="card" id="panelFeed">
      <div class="cinemaTitle">
        <div class="cinemaDot"></div>
        <div>
          <div class="big">ğŸ¥ æ¼‚æµ®å½±å»³ï¼ˆè²¼æ–‡ç‰†ï¼‰</div>
          <div class="small">
            ä»¥ã€Œé›»å½±é™¢è¢å¹•ã€çš„æ–¹å¼æ»‘å‹•çœ‹è²¼æ–‡ã€‚<br>
            è¨ªå®¢å¯çœ‹è²¼æ–‡ä½†ä¸å¯äº’å‹•ï¼ˆæŒ‰è®š/ç•™è¨€ä¹‹å¾Œå†åšï¼‰ã€‚
          </div>
        </div>
      </div>

      <div class="searchRow">
        <input id="q" placeholder="æœå°‹ç‰‡å / #hashtagâ€¦" />
        <div class="countPill" id="count">å…± 0 ç­†</div>
      </div>

      <div class="feed" id="feed"></div>
      <div class="feed" id="singleWrap" style="display:none;"></div>

      <div class="hint" id="panelAbout" style="display:none;">
        <div style="font-weight:900;margin-bottom:8px;">âœ¨ é—œæ–¼ MovieBase</div>
        <div>
          é€™è£¡æ˜¯ã€Œè§€å½±ç´€éŒ„ + ç¤¾ç¾¤åˆ†äº«ã€çš„å…¥å£é  MVPã€‚<br>
          ä¸‹ä¸€æ­¥æˆ‘å€‘æœƒåšï¼š<b>æˆ‘çš„ç´€éŒ„ï¼ˆä¸‰å€ï¼‰</b>ã€<b>è²¼æ–‡ç‰† hashtag æœå°‹</b>ã€<b>è¨ªå®¢é™åˆ¶äº’å‹•</b>ã€<b>é€šçŸ¥å°éˆ´éº</b>ã€‚<br><br>
          âœ… ç›®å‰é€™é è² è²¬ï¼šposts çš„ list / get / createã€ä»¥åŠ Google ç™»å…¥é©—è­‰ï¼ˆaction: meï¼‰ã€‚
        </div>
      </div>
    </section>
  </main>

  <script>
    /* =========================
       âœ… 0) ä½ åªè¦æ”¹é€™å…©å€‹
    ========================= */

    // ä½ çš„ Apps Script Web App /exec
    const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyuipb05zxPbPp7iAotqe_Oya4je2s-l3COcJ8kDO7e4VHjdLRuNwJhrymkPN02b9Sd/exec";

    // ä½ çš„ Google OAuth Web Client ID
    const GOOGLE_CLIENT_ID = "709445153038-vh9tvcrk5vtj0r3il5r81j9gl1k68l98.apps.googleusercontent.com";

    /* =========================
       âœ… 1) Helpers
    ========================= */
    const $ = (id) => document.getElementById(id);

    function setStatus(msg, type="") {
      const el = $("status");
      el.className = "status " + (type || "");
      el.textContent = msg || "";
    }

    function todayISO() {
      const d = new Date();
      const z = (n) => String(n).padStart(2, "0");
      return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
    }

    async function fileToBase64(file) {
      if (!file) return "";
      const reader = new FileReader();
      return await new Promise((resolve, reject) => {
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function apiGET(params) {
      const url = new URL(GAS_WEBAPP_URL);
      Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, v));
      const res = await fetch(url.toString());
      const text = await res.text();
      try { return JSON.parse(text); }
      catch { throw new Error("GET å›å‚³ä¸æ˜¯ JSONï¼š" + text.slice(0, 160)); }
    }

    async function apiPOST(payload) {
      const res = await fetch(GAS_WEBAPP_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload),
      });

      const text = await res.text();
      console.log("GAS raw response:", text);

      try { return JSON.parse(text); }
      catch { throw new Error("POST å›å‚³ä¸æ˜¯ JSONï¼š" + text.slice(0, 160)); }
    }

    function escapeHtml(str) {
      return (str ?? "").toString().replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function fmtTS(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      return d.toLocaleString("zh-TW", { hour12: false });
    }

    function getQueryId() {
      return new URLSearchParams(location.search).get("id");
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        setStatus("å·²è¤‡è£½åˆ†äº«é€£çµ âœ…", "ok");
      } catch {
        prompt("è¤‡è£½é€™å€‹é€£çµåˆ†äº«ï¼š", text);
      }
    }

    /* =========================
       âœ… 2) Login Mode
    ========================= */
    let currentUser = null; // {sub,email,name,picture}
    let isGuest = false;

    function showLoggedOut(){
      currentUser = null;
      isGuest = false;

      $("modeBadge").textContent = "ç›®å‰ï¼šæœªç™»å…¥";
      $("loginButtons").style.display = "flex";
      $("userBox").style.display = "none";
      $("userPic").style.display = "none";
      $("userName").textContent = "";
      $("createHint").textContent = "ç™»å…¥å¾Œå¯å¸¶å…¥ä½œè€…è³‡è¨Š";
    }

    function showGuest(){
      currentUser = null;
      isGuest = true;

      $("modeBadge").textContent = "ç›®å‰ï¼šè¨ªå®¢æ¨¡å¼";
      $("loginButtons").style.display = "flex";
      $("userBox").style.display = "none";
      $("userPic").style.display = "none";
      $("userName").textContent = "";
      $("createHint").textContent = "è¨ªå®¢ä¹Ÿèƒ½ç™¼æ–‡ï¼ˆä¹‹å¾Œå¯é™åˆ¶ï¼‰";
    }

    function showLoggedIn(user){
      currentUser = user;
      isGuest = false;

      $("modeBadge").textContent = "ç›®å‰ï¼šå·²ç™»å…¥";
      $("loginButtons").style.display = "none";
      $("userBox").style.display = "flex";
      $("userName").textContent = user.name || user.email || "";

      if (user.picture){
        $("userPic").src = user.picture;
        $("userPic").style.display = "block";
      } else {
        $("userPic").style.display = "none";
      }
      $("createHint").textContent = "ä½œè€…æœƒå¯«å…¥ postsï¼ˆauthorName/Email/Subï¼‰";
    }

    async function restoreLogin(){
      const idToken = localStorage.getItem("id_token");
      if (!idToken){
        showLoggedOut();
        return;
      }

      try{
        setStatus("é©—è­‰ç™»å…¥ä¸­â€¦");
        const data = await apiPOST({ action: "me", idToken });
        console.log("me response:", data);

        if (!data.ok) throw new Error(data.error || "me failed");
        showLoggedIn(data.user);
        setStatus("ç™»å…¥æˆåŠŸ âœ… " + (data.user.email || ""), "ok");
      } catch(e){
        console.error(e);
        localStorage.removeItem("id_token");
        showLoggedOut();
        setStatus("ç™»å…¥é©—è­‰å¤±æ•—ï¼š" + String(e.message || e), "err");
      }
    }

    function initGoogleLogin(){
      if (!window.google || !google.accounts?.id){
        console.warn("Google SDK not ready");
        return;
      }

      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: async (resp) => {
          localStorage.setItem("id_token", resp.credential);
          await restoreLogin();
        },
      });

      google.accounts.id.renderButton($("gsiBtn"), { theme: "outline", size: "large" });

      restoreLogin();
    }

    /* =========================
       âœ… 3) Feed / Single
    ========================= */
    let allRows = [];

    function renderFeed(rows){
      const feed = $("feed");
      const singleWrap = $("singleWrap");

      feed.style.display = "grid";
      singleWrap.style.display = "none";
      singleWrap.innerHTML = "";
      feed.innerHTML = "";

      const sorted = [...rows].sort((a,b)=> new Date(b.ts) - new Date(a.ts));

      sorted.forEach(r=>{
        const card = document.createElement("div");
        card.className = "post";

        const avatarChar = (r.authorName || r.title || "?").trim().slice(0,1);
        const imgHtml = r.photoUrl
          ? `<img class="postImg" src="${escapeHtml(r.photoUrl)}" alt="">`
          : `<div style="height:260px;background:rgba(255,255,255,.06);"></div>`;

        const shareLink = `${location.origin}${location.pathname}?id=${encodeURIComponent(r.id)}`;

        const tags = (r.hashtags || "").trim();
        const tagsHtml = tags ? `<span class="badge">${escapeHtml(tags)}</span>` : "";

        card.innerHTML = `
          <div class="postHead">
            <div class="user">
              <div class="avatar">${escapeHtml(avatarChar)}</div>
              <div class="uMeta">
                <div class="uTitle">${escapeHtml(r.title || "")}</div>
                <div class="uSub">${escapeHtml(r.category || "")}ãƒ»${escapeHtml(r.platform || "")}ãƒ»è©•åˆ† ${escapeHtml(r.rating || "")}/10</div>
              </div>
            </div>
            <div class="ts">${escapeHtml(fmtTS(r.ts))}</div>
          </div>

          ${imgHtml}

          <div class="postActions">
            <button class="chipBtn" data-share="${escapeHtml(r.id)}" type="button">ğŸ”— Share</button>
            <a class="chipBtn" href="?id=${encodeURIComponent(r.id)}" style="text-decoration:none;">ğŸ” çœ‹è²¼æ–‡</a>
          </div>

          <div class="postBody">
            <div class="badges">
              <span class="badge">æ—¥æœŸ ${escapeHtml(r.watchDate || "")}</span>
              <span class="badge">ä½œè€… ${escapeHtml(r.authorName || "åŒ¿å")}</span>
              ${tagsHtml}
            </div>
            <div class="text">${escapeHtml(r.review || "")}</div>
            <div class="badge">${escapeHtml(r.note || "")}</div>
          </div>
        `;

        card.querySelector("[data-share]").addEventListener("click", ()=> copyToClipboard(shareLink));
        feed.appendChild(card);
      });

      $("count").textContent = `å…± ${sorted.length} ç­†`;
    }

    async function loadList(){
      setStatus("è¼‰å…¥è²¼æ–‡ç‰†ä¸­â€¦");
      try{
        const data = await apiGET({ action: "list_posts" });
        if (!data.ok) throw new Error(data.error || "list_posts failed");
        allRows = data.rows || [];
        applyFilter();
        setStatus("è²¼æ–‡ç‰†è¼‰å…¥å®Œæˆ âœ…", "ok");
      } catch(e){
        console.error(e);
        setStatus("è¼‰å…¥å¤±æ•—ï¼šè«‹ç¢ºèª GAS /exec èˆ‡ posts è¡¨æ¬„ä½ âœ…\n" + String(e.message || e), "err");
      }
    }

    async function loadSingle(id){
      setStatus("è¼‰å…¥è²¼æ–‡ä¸­â€¦");
      try{
        const data = await apiGET({ action: "get_post", id });
        if (!data.ok) throw new Error(data.error || "get_post failed");
        const r = data.row;

        $("feed").style.display = "none";
        const singleWrap = $("singleWrap");
        singleWrap.style.display = "grid";
        singleWrap.innerHTML = "";

        if (!r){
          singleWrap.innerHTML = `<div class="status err">æ‰¾ä¸åˆ°é€™ç¯‡è²¼æ–‡ï¼ˆid=${escapeHtml(id)}ï¼‰</div>`;
          setStatus("æ‰¾ä¸åˆ°è²¼æ–‡", "err");
          return;
        }

        const shareLink = `${location.origin}${location.pathname}?id=${encodeURIComponent(r.id)}`;
        const imgHtml = r.photoUrl
          ? `<img class="postImg" src="${escapeHtml(r.photoUrl)}" alt="">`
          : `<div style="height:260px;background:rgba(255,255,255,.06);"></div>`;

        const tags = (r.hashtags || "").trim();
        const tagsHtml = tags ? `<span class="badge">${escapeHtml(tags)}</span>` : "";

        const card = document.createElement("div");
        card.className = "post";
        card.innerHTML = `
          <div class="postHead">
            <div class="user">
              <div class="avatar">${escapeHtml((r.authorName || r.title || "?").trim().slice(0,1))}</div>
              <div class="uMeta">
                <div class="uTitle">${escapeHtml(r.title || "")}</div>
                <div class="uSub">${escapeHtml(r.category || "")}ãƒ»${escapeHtml(r.platform || "")}ãƒ»è©•åˆ† ${escapeHtml(r.rating || "")}/10</div>
              </div>
            </div>
            <div class="ts">${escapeHtml(fmtTS(r.ts))}</div>
          </div>

          ${imgHtml}

          <div class="postActions">
            <button class="chipBtn" id="singleShare" type="button">ğŸ”— Share</button>
            <a class="chipBtn" href="./" style="text-decoration:none;">â¬… å›åˆ°è²¼æ–‡ç‰†</a>
          </div>

          <div class="postBody">
            <div class="badges">
              <span class="badge">æ—¥æœŸ ${escapeHtml(r.watchDate || "")}</span>
              <span class="badge">ä½œè€… ${escapeHtml(r.authorName || "åŒ¿å")}</span>
              ${tagsHtml}
            </div>
            <div class="text">${escapeHtml(r.review || "")}</div>
            <div class="badge">${escapeHtml(r.note || "")}</div>
          </div>
        `;
        singleWrap.appendChild(card);

        $("singleShare").addEventListener("click", ()=> copyToClipboard(shareLink));
        setStatus("è²¼æ–‡è¼‰å…¥å®Œæˆ âœ…", "ok");
      } catch(e){
        console.error(e);
        setStatus("è¼‰å…¥è²¼æ–‡å¤±æ•—ï¼š" + String(e.message || e), "err");
      }
    }

    function applyFilter(){
      const q = $("q").value.trim().toLowerCase();
      const rows = q
        ? allRows.filter(r => ((r.title||"") + " " + (r.hashtags||"") + " " + (r.review||"")).toLowerCase().includes(q))
        : allRows;
      renderFeed(rows);
    }

    /* =========================
       âœ… 4) Create post
    ========================= */
    async function createPost(){
      const title = $("title").value.trim();
      if (!title) return setStatus("ç‰‡åå¿…å¡«", "err");

      $("btnCreate").disabled = true;
      setStatus("æ–°å¢ä¸­â€¦");

      try{
        const photoBase64 = await fileToBase64($("photo").files[0]);

        // ä½œè€…è³‡è¨Šï¼šè‹¥å·²ç™»å…¥å°±å¯«å…¥ï¼Œè¨ªå®¢å°±ç•™ç©º
        const authorSub = currentUser?.sub || "";
        const authorName = currentUser?.name || "";
        const authorEmail = currentUser?.email || "";

        const payload = {
          action: "create_post",
          title,
          category: $("category").value,
          platform: $("platform").value,
          rating: Number($("rating").value || 0),
          watchDate: $("watchDate").value,
          review: $("review").value,
          note: $("note").value,
          hashtags: $("hashtags").value,
          photo: photoBase64,
          authorSub,
          authorName,
          authorEmail
        };

        const data = await apiPOST(payload);
        if (!data.ok) throw new Error(data.error || "create_post failed");

        setStatus("æ–°å¢æˆåŠŸ âœ…", "ok");

        $("title").value = "";
        $("review").value = "";
        $("note").value = "";
        $("hashtags").value = "";
        $("photo").value = "";
        $("photoPreview").src = "";

        await loadList();

        // mobileï¼šæ–°å¢å®Œè‡ªå‹•å›è²¼æ–‡ç‰†
        if (window.matchMedia("(max-width: 979px)").matches){
          setActiveTab("feed");
        }
      } catch(e){
        console.error(e);
        setStatus("æ–°å¢å¤±æ•—ï¼š" + String(e.message || e), "err");
      } finally{
        $("btnCreate").disabled = false;
      }
    }

    /* =========================
       âœ… 5) Tabs (RWD)
    ========================= */
    function setActiveTab(name){
      document.querySelectorAll(".tab").forEach(btn=>{
        btn.classList.toggle("is-active", btn.dataset.tab === name);
      });

      const isMobile = window.matchMedia("(max-width: 979px)").matches;

      const panelCreate = $("panelCreate");
      const panelFeed = $("panelFeed");
      const panelAbout = $("panelAbout");

      if (!isMobile){
        // desktop: å·¦ create, å³ feed
        panelCreate.style.display = "";
        panelFeed.style.display = "";
        panelAbout.style.display = (name === "about") ? "" : "none";
      } else {
        // mobile: å–®æ¬„åˆ‡æ›
        if (name === "create"){
          panelCreate.style.display = "";
          panelFeed.style.display = "none";
        } else {
          panelCreate.style.display = "none";
          panelFeed.style.display = "";
          panelAbout.style.display = (name === "about") ? "" : "none";
        }
      }

      // å–®ç¯‡ / feed è¼‰å…¥
      if (name !== "create"){
        const id = getQueryId();
        if (id) loadSingle(id);
        else loadList();
      }
    }

    /* =========================
       âœ… 6) Boot
    ========================= */
    window.addEventListener("load", () => {
      $("watchDate").value = todayISO();

      $("photo").addEventListener("change", async () => {
        const f = $("photo").files[0];
        $("photoPreview").src = f ? await fileToBase64(f) : "";
      });

      $("btnCreate").addEventListener("click", createPost);
      $("btnReload").addEventListener("click", loadList);
      $("q").addEventListener("input", applyFilter);

      $("tabs").addEventListener("click", (e) => {
        const btn = e.target.closest(".tab");
        if (!btn) return;
        setActiveTab(btn.dataset.tab);
      });

      window.addEventListener("resize", () => {
        const active = document.querySelector(".tab.is-active")?.dataset.tab || "feed";
        setActiveTab(active);
      });

      $("btnGuest").addEventListener("click", () => {
        showGuest();
        setStatus("å·²é€²å…¥è¨ªå®¢æ¨¡å¼ï¼ˆå¯çœ‹è²¼æ–‡/å¯æ–°å¢è²¼æ–‡ï¼›äº’å‹•åŠŸèƒ½ä¹‹å¾Œé™åˆ¶ï¼‰", "warn");
        setActiveTab("feed");
      });

      $("btnLogout").addEventListener("click", () => {
        if (window.google?.accounts?.id) google.accounts.id.disableAutoSelect();
        localStorage.removeItem("id_token");
        showLoggedOut();
        setStatus("å·²ç™»å‡º", "warn");
      });

      // åˆå§‹åŒ–ç™»å…¥
      initGoogleLogin();

      // é è¨­é€²è²¼æ–‡ç‰†
      setActiveTab("feed");
    });
  </script>
</body>
</html>
