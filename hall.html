<script src="./assets/app.js?v=20251224_1"></script>

<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MovieBase｜漂浮影廳</title>

  <!-- ✅ 先載入 theme（提供變數/共用元件風格） -->
  <link rel="stylesheet" href="./assets/theme.css">
  <!-- ✅ 再載入你的頁面樣式（最好都用 var(--bg/--text/--stroke)） -->
  <link rel="stylesheet" href="./assets/style.css" />

  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>

<body>
  <div class="bg-float"></div>

  <div class="topbar">
    <div class="nav">
      <div class="brand">
        <div class="logoDot"></div>
        <button class="btn" id="themeToggle" type="button">Theme</button>
        <div class="brandTitle">
          <b>MovieBase</b>
          <span>漂浮影廳（貼文牆）</span>
        </div>
      </div>

      <div class="navLinks">
        <a class="pill" data-nav href="about.html">網站介紹</a>
        <a class="pill" data-nav href="records.html">我的紀錄</a>
        <a class="pill" data-nav href="hall.html">漂浮影廳</a>
        <a class="pill" data-nav href="account.html">我的帳戶</a>
      </div>

      <div class="rightBox">
        <span class="badge" id="authBadge">目前：讀取中…</span>
        <img class="avatar" id="authPic" alt="">
        <span class="badge" id="authName">...</span>

        <!-- app.js 會依狀態自動顯示/隱藏 -->
        <button class="btn" id="btnOpenLogin" type="button">登入 / 訪客</button>
        <button class="btn danger" id="btnLogout" type="button" style="display:none;">登出</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <section class="card">
        <h2>大螢幕貼文牆（下一步會做成真正的「電影螢幕」）</h2>
        <div class="muted">
          這頁會像 Threads/IG：滑動看貼文。<br>
          你要求：不分類，但有 <b>#hashtag</b> + 搜尋欄位。<br><br>
          ✅ 訪客：可以看貼文<br>
          🔒 訪客：不能按讚/留言/發文（我們會鎖）
        </div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn primary" id="btnNewPost" type="button">＋ 新增貼文</button>
          <button class="btn" id="btnLike" type="button">♡ 按讚（測試）</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          第 3 步才會把：hashtag 搜尋、從我的紀錄複製成貼文、編輯刪除、通知鐘 全部做完。
        </div>
      </section>

      <section class="card">
        <h2>訪客限制（先做正確）</h2>
        <div class="muted" id="hallGuard">狀態讀取中…</div>
        <div class="hr"></div>
        <div class="muted">
          你要求：訪客「不能按讚、留言」且你補充「訪客不能發文」。<br>
          ✅ 我們已先在前端鎖住，下一步會在後端也鎖住（避免繞過）。
        </div>
      </section>
    </div>
  </div>

  <!-- Login modal：這頁維持原版（登入/訪客） -->
  <div class="modal" id="loginModal">
    <div class="modalBox fadeIn">
      <h3>需要登入才能互動</h3>
      <div class="small">按讚 / 留言 / 發文 需要 Google 登入。</div>
      <div class="hr"></div>
      <div id="gsiBtn"></div>
      <div class="hr"></div>
      <button class="btn" id="btnGuest" type="button">我先當訪客看就好</button>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- ✅ 讓 app.js 先載完再跑頁面 script -->
  <script src="./assets/app.js" defer></script>

  <script>
    // 等 MB 初始化完成（mode 不再是 unknown）再更新 UI/綁事件
    function waitForMBReady(timeoutMs = 5000) {
      const start = Date.now();
      return new Promise((resolve) => {
        const tick = () => {
          if (window.MB && MB.state && MB.state.mode && MB.state.mode !== "unknown") return resolve(true);
          if (Date.now() - start > timeoutMs) return resolve(false);
          setTimeout(tick, 80);
        };
        tick();
      });
    }

    window.addEventListener("load", async () => {
      const ok = await waitForMBReady();
      const el = document.getElementById("hallGuard");

      // 即使 timeout，也不讓頁面壞掉
      const mode = (ok && MB.state.mode) ? MB.state.mode : "guest";

      el.textContent = (mode === "user")
        ? "✅ 已登入：可以互動（第 3 步才接上按讚留言）"
        : "👀 訪客模式：可看貼文，但互動會被鎖";

      document.getElementById("btnNewPost").addEventListener("click", () => {
        if (!MB_requireLogin("新增貼文")) return;
        toast("下一步才會做：新增貼文（從我的紀錄 / 新的分享）");
      });

      document.getElementById("btnLike").addEventListener("click", () => {
        if (!MB_requireLogin("按讚")) return;
        toast("下一步才會做：按讚寫入試算表");
      });
    });
  </script>
</body>
</html>
